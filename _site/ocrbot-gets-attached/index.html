<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>OCRBot Gets Attached - Waterfalls of Data - Data science in the world of software dev</title>
	<meta name="description" content="A short chatterbot dev story Part">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicon/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicon/apple-touch-icon-114x114.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#d25469">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#d25469">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#d25469">
	<!-- Fonts -->
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/css/main.css">
</head>

<body>

  
<header class="main_header">
  <a href="/" class="logo">WD</a>
  <nav class="main_menu">
    <a href="/about/">About</a>
    <!--<a href="/contact/">Contact</a>-->
  </nav>
</header> <!-- End Section Header -->

<main class="post_content">
  <article class="post">
    <header>
      <div class="post_image">
        <img src=/assets/img/flower_blue_mharris.jpg alt="OCRBot Gets Attached">
      </div>
      <div class="post_description">
        <p class="post_meta">2017, Mar 01</p>
        <h1 class="post_title">OCRBot Gets Attached</h1>
      </div>
    </header> <!-- End Header -->

    <div class="entry_content">
      <p><img src="/img/bot_part3/knn_mharris_letters.jpg" alt="" /></p>

<p><a href="https://en.wikipedia.org/wiki/TL;DR"><strong>tl;dr</strong></a>:  Chatterbots are trending bigtime!  Here, we continue the story of OCRBot, a word recognizing chatbot.  OCRBot’s new ability to get image text from attachments is revealed (adding to it’s existing ability to take image web links).  So, we can snap a picture of some text and OCRbot finds the words.  This could lead us into even more exciting realms like text to speech or translation.</p>

<p align="right"><b>For OCR, commonly a k-nearest neighbors classifier is used for character recognition</b></p>

<p>For the first two stories, see <a href="https://michhar.github.io/posts/how-to-bot-on-mac">Part 1</a> and <a href="https://michhar.github.io/posts/ocrbot-makes-a-connection">Part 2</a>.</p>

<h3 id="whats-the-wow-factor">What’s the wow factor?</h3>

<p>Have you ever just wanted the text extracted from, perhaps a page in a book or a funny comic that’s sitting around in an image?  Or maybe it’d be helpful to take a snapshot of a menu item wherein the font is a bit too small or you forgot your reading glasses, however, it’s easy to read on your phone as plain text. Now, if you send the OCRBot an image (jpeg, png, gif, bmp are its known formats), on one of its supported conversational platforms like Skype or Slack, you’ll get that text you crave.</p>

<p><img src="/img/bot_part3/ocrbot_skype.jpg" alt="ocr bot with my coaster" /></p>

<p align="right"><b>OCRBot on Skype - using a photo I just took of my favorite coaster sitting on my coffee table currently</b></p>

<p>This is not only fun and useful it could be the precursor to adding text to speech, or TTS, to the bot itself as we’ve got a Cognitive Servies API for that (Bing Speech).  You can, of course at this point even, pipe this text into one of your TTS apps already on your device.</p>

<h3 id="reintroducing-ocr">(Re)Introducing OCR</h3>

<p>OCR, or optical character recognition, is the electronic or mechnanical recognition of text in images and the conversion into machine-encoded representaions.  The text could be handwritten, typed or printed.  The data is an image such as scanned passports or financial data, business cards, postal mail, or any document as an image that someone wishes to digitize.</p>

<p>Sometimes, OCR uses the human mind as the intelligence algorithms.  An example is the use of reCAPTCHA as a crowdsourcing effort for a two-fold purpose:  verification that the entity logging in somewhere is not a bot and crowdsourcing the recognition of hard to read text for the archiving of say 13 million articles from the NY Times starting with articles from 1851 which was accomplished in 2011 along with all of the books on Google Books.</p>

<p>OCR is performed through <strong><a href="https://en.wikipedia.org/wiki/Pattern_recognition">pattern recognition</a></strong> with components often pulled from AI and computer vision.  The process usually takes the form of:  pre-processing (fixing skew, noise reduction, conversion to black-and-white, and the like) - see figure below; character or word recognition through feature extraction and, often, a k-nearest neighbors classification (see figure below), one of the simplest of ML algorithms; post-processing such as validation through seeing co-occurrences of words (words that usually go together like “ice cream” instead of “ice pizza”).  See the <a href="https://en.wikipedia.org/wiki/Optical_character_recognition">Wikipedia article on OCR</a> for more.</p>

<p>In the Cognitive Services OCR, we have the idea of word detection within bounding boxes, combining pre-processing and several ML algorithms such as the feature extraction mentioned above, another set of algorithms for classification (including convolutional neural networks) and validation through simillar means as above, plus using a vocabulary and other techniques.</p>

<p>Pre-processing example:</p>

<p><img src="/img/bot_part3/pre_process.jpg" alt="pre-processing example" /></p>

<p align="right"><b>An example of image pre-processing for character recognition:  fixing skew, binarisation, despekling, and line removal</b></p>

<p>k-nearest neighbor example:</p>

<p><img src="/img/bot_part3/knn_mharris_letters.jpg" alt="k-nearest neighbors example" /></p>

<p align="right"><b>Classifying the orange letter as a blue D or green P.  Note, that if k is 3, the orange letter is classified as a blue D, but with a k of 7 it is classified as a green P.  The structure of the data can cause for a tricky problem in k-NN</b></p>

<p>Nowadays, especially on devices like smart phones, the OCR model used to do this conversion to text is done in the cloud through an API.  This is how the Computer Vision API for OCR under the Cognitive Services umbrealla on Azure gets it done.</p>

<p>And for those who like a little history, note that OCR was known to be used in devices as early as 1914 with Emanuel Goldberg’s invention of a machine that could read characters and convert them into standard <a href="https://en.wikipedia.org/wiki/Telegraph_code">telegraph code</a> like Morse code (see <a href="https://en.wikipedia.org/wiki/Optical_character_recognition">this Wikipedia</a> article for more history).  Skip ahead to today and we have optical word recognition (commonly called OCR) used for typewritten text and others like intelligent character recognition (ICR) for handwritten or cursive text.</p>

<h3 id="how-has-ocrbots-code-changed">How has OCRBot’s code changed</h3>

<h4 id="from-the-original-ocrbot">From the original OCRBot</h4>

<p>OCRBot began with the ability to take a web link of an image with text and give us back the actual text in <a href="https://michhar.github.io/posts/how-to-bot-on-mac">Post 1</a>.  Now we’ve updated OCRBot quite a bit to also accept images as attachments to the conversation.</p>

<p>Simply check out the <code class="highlighter-rouge">server.js</code> at github link <a href="https://github.com/michhar/bot-education-ocrbot">here</a> for the new changes to OCRBot of which there are quite a few.  Certainly an overhaul of sorts, one of which was the incorporation of promises…</p>

<h4 id="a-promise">A Promise…</h4>

<p>What is a Promise?  Let’s start with a promise of a promise that I like (ok, I had to go there) from an article by Marc Harter found <a href="https://strongloop.com/strongblog/promises-in-node-js-an-alternative-to-callbacks/">here</a>.</p>

<blockquote>
  <p>Promises are a compelling alternative to callbacks when dealing with asynchronous code. […] Callbacks are the simplest possible mechanism for asynchronous code in JavaScript. Unfortunately, raw callbacks sacrifice the control flow, exception handling, and function semantics familiar from synchronous code. Promises provide a way to get those things back.</p>
</blockquote>

<p>See <a href="https://en.wikipedia.org/wiki/Parallel_computing">this</a> article if you are unfamiliar with the meaning of asychronous.</p>

<p>Key concepts (don’t worry if this doesn’t quite make sense yet) of a promise are as follows (paraphrased from info in Harter’s article).</p>

<ul>
  <li>A <code class="highlighter-rouge">promise</code> (one way to think about them), is a value representing an asynchronous operation that is only fufilled once, either being resolved or rejected (we’ll see in code soon).</li>
  <li><code class="highlighter-rouge">then</code>, a reserved word for promises, allows anyone with access to the promise to be able to consume it <em>regardless of if the asynchronous operation is done or not</em>.  One way to think about them is as a function which unwraps the asynchronous operation’s result from the promise.  <code class="highlighter-rouge">then</code> returns a promise.</li>
  <li><code class="highlighter-rouge">catch</code> is often used after a <code class="highlighter-rouge">then</code>, series of <code class="highlighter-rouge">then</code>s, or some nested <code class="highlighter-rouge">then</code>s to handle errors both implicitly and explicitly if the ned arises.</li>
  <li>We can still use <code class="highlighter-rouge">return</code> to model syncrhonous functions by returning a promise or any other value that and then signaling the next <code class="highlighter-rouge">then</code>, possibly giving this value to the next <code class="highlighter-rouge">onFufilled</code>.</li>
  <li><code class="highlighter-rouge">onFufilled</code> and <code class="highlighter-rouge">onRejected</code> are the callbacks and handlers that <code class="highlighter-rouge">then</code> handles to signal what to do with the results of a promise.</li>
</ul>

<p>Here’s a simple representation in code of the logic changes a promise provides.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">readFile</span><span class="p">()</span>
<span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span>
</code></pre>
</div>

<p>In this example, <code class="highlighter-rouge">readFile</code> does, in fact, need to return a promise.  This object can now be used with any <code class="highlighter-rouge">then</code> that has access to the promise.  You’ll notice that the <code class="highlighter-rouge">then</code> has two bits to it.  If the promise is fufilled in <code class="highlighter-rouge">readFile</code> the first (<code class="highlighter-rouge">console.log</code>) chunk of code is called, and if rejected, the second chunk is called (<code class="highlighter-rouge">console.error</code>).</p>

<p>We can create raw promises in the following way.  In this example, we are using the <code class="highlighter-rouge">fs</code> library’s <code class="highlighter-rouge">readFile</code> method, using <code class="highlighter-rouge">reject</code> to pass on the result of the promise in the case of an error, and <code class="highlighter-rouge">resolve</code> if it is fufilled or simply not rejected, wrapping all of this up in a function which returns the promise to be used by a <code class="highlighter-rouge">then</code>.  Then, the next <code class="highlighter-rouge">then</code> that consumes this promise-returning function “unwraps” that logic.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">readFileAsync</span> <span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">encoding</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="c1">// rejects the promise with `err` as the reason</span>
      <span class="nx">resolve</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>               <span class="c1">// fulfills the promise with `data` as the value</span>
    <span class="p">})</span>
  <span class="p">})</span>
<span class="p">}</span>
<span class="nx">readFileAsync</span><span class="p">(</span><span class="s1">'myfile.txt'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span>
</code></pre>
</div>

<p>In a similar way, the OCRBot’s code now includes promises and this looks like the raw promise above with the clever use of a <code class="highlighter-rouge">catch</code> to catch any unhandled errors and give some information back to the app and user.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">fileDownload</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">(</span>
                <span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">check</span> <span class="o">=</span> <span class="nx">checkRequiresToken</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
                    <span class="k">if</span>  <span class="p">(</span><span class="nx">check</span><span class="o">==</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">resolve</span><span class="p">(</span><span class="nx">requestWithToken</span><span class="p">(</span><span class="nx">attachment</span><span class="p">.</span><span class="nx">contentUrl</span><span class="p">));</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">resolve</span><span class="p">(</span><span class="nx">request_promise</span><span class="p">(</span><span class="nx">attachment</span><span class="p">.</span><span class="nx">contentUrl</span><span class="p">));</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">);</span>

            <span class="nx">fileDownload</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span>
                <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>

                <span class="nx">readImageText</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">attachment</span><span class="p">.</span><span class="nx">contentType</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">session</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">extractText</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span>
                <span class="p">});</span>

                <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Error with attachment: '</span><span class="p">,</span> <span class="p">{</span> 
                        <span class="na">statusCode</span><span class="p">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">,</span> 
                        <span class="na">message</span><span class="p">:</span> <span class="nx">err</span> <span class="p">});</span>
                        <span class="nx">session</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"Error with attachment or reading image with %s"</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
            <span class="p">});</span>
</code></pre>
</div>

<p>Promises are quite amazing, leading to resolving many issues around Node.js code such as too many nested callbacks (aka “callback hell”) and clean error handling.  I hope you got a bit of that enthusiasm from reading through this section.</p>

<h3 id="the-end-of-this-chapter-and-ocrbots-next-adventure">The end of this chapter and OCRBot’s next adventure</h3>

<p>I’m actually not sure what will be in store for OCRBot next.  There are so many fantastic “smarts” we could add or clever functionality.  It’ll have to wait and be revealed when OCRBot returns to this blog.</p>

<p>Thanks for reading!</p>

<p><img src="/img/bot_part3/ocrbot_attached.jpg" alt="happy bot" /></p>


    </div>
    
    <div class="post_wrapper">
      <footer class="post_footer cf">
        <div class="post_share">
          <span>Share:</span>
          <a href="https://twitter.com/intent/tweet?text=OCRBot Gets Attached&url=http://localhost:4000/ocrbot-gets-attached/" title="Share on Twitter" rel="nofollow" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a>
          <a href="https://facebook.com/sharer.php?u=http://localhost:4000/ocrbot-gets-attached/" title="Share on Facebook" rel="nofollow" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a>
          <a href="https://plus.google.com/share?url=http://localhost:4000/ocrbot-gets-attached/" title="Share on Google+" rel="nofollow" target="_blank"><i class="fa fa-google" aria-hidden="true"></i></a>
        </div>
        <div class="post_tag">
          <span>Tags:</span>
          
          <a href="/tags#bots" class="tag">bots</a>
          
          <a href="/tags#dev" class="tag">dev</a>
          
        </div>
      </footer>
    </div>
  </article> <!-- End Section Post -->

  <section class="author cf">
    <div class="post_wrapper">
      <div class="author_image">
        <img src="/assets/img/climb_sketch_mharris.JPG" alt="Author face">
      </div>
      <div class="author_info">
        <h2 class="author_title">Micheleen Harris</h2>
        <p class="author_subtitle">pythonista data science dev glacier seeker sock knitter</p>
        <div class="author_social">
          
          

          
          <span class="author_website"><i class="fa fa-link" aria-hidden="true"></i> <a href="https://michhar.github.io" target="_blank">https://michhar.github.io</a></span>
                      
        </div>
      </div>
    </div>
  </section> <!-- End Section Author -->

  <section class="recent_box">
    <div class="post_wrapper">
      <h2 class="recent_title">Recent post</h2>
      <div class="recent_list">
        
          
            <a href="/cntk-has-feelings-too/" class="recent_item" style="background-image: url( /assets/img/cntk.jpg )"><span>The Cognitive Toolkit (CNTK) Understands How You Feel</span></a>
          
        
          
            <a href="/masks_to_polygons_and_back/" class="recent_item" style="background-image: url( /assets/img/yosemite_mharris.jpg )"><span>Shapely Shapes and OpenCV Visions</span></a>
          
        
          
            <a href="/single-artifical-neuron-for-nonlinear-separable-data/" class="recent_item" style="background-image: url( /assets/img/chimi_mharris.jpg )"><span>On using an Adaline Artificial Neuron for Classification</span></a>
          
        
          
            <a href="/my-new-static-site-generator-hobby/" class="recent_item" style="background-image: url( /assets/img/IMG_3455.JPG )"><span>Overlaying a Website ontop of a GitHub Repository</span></a>
          
        
          
            <a href="/data-science-story-part1/" class="recent_item" style="background-image: url( /assets/img/rainier1_mharris.jpg )"><span>How I Became a Data Scientist</span></a>
          
        
          
            <a href="/two-cents-on-python-package-structure/" class="recent_item" style="background-image: url( /assets/img/ecuador_warmup_mharris.jpg )"><span>Wading In a Tide Pool of Choices, How to Write a Package in Python?</span></a>
          
        
      </div>
    </div>
  </section> <!-- End Section Recent Box -->
  
  
<section class="comment_area">
  <div class="comment_wrapper">
    
    <div id="disqus_thread" class="article-comments"></div>
    <script>
      (function() {
          var d = document, s = d.createElement('script');
          s.src = '//michhar.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
  </div>
</section> <!-- End Section Comment Area -->
  
</main> <!-- End Section Post Content -->


<footer class="main_footer">
  <div class="wrapper">
    
<ul class="social_footer">
  
  <li><a href="https://github.com/michhar" target="_blank"><i class="fa fa-github" aria-hidden="true"></i></a></li>
  
  
  <li><a href="https://twitter.com/rheartpython" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
  
  
  
  
  
</ul>
    <div class="copyright">
      <p>&copy; 2017 All rights reserved. <a href="https://michhar.github.io" target="_blank">Micheleen Harris</a></p>
    </div>
  </div>
</footer> <!-- End Section Footer -->


  
<div class="top" title="Top"><i class="fa fa-chevron-up" aria-hidden="true"></i></div> <!-- End Top Scroll -->
  
<script src="/assets/js/jquery-3.2.1.min.js"></script>
<script src="/assets/js/jquery.vide.min.js"></script>
<script src="/assets/js/custom.js"></script>
<!-- End Javascript -->

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-86308542-1', 'auto');
  ga('send', 'pageview');
</script> <!-- End Analytics -->
</body>
</html>
