<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Waterfalls of data | Creating a Python Flask Web App that Uses an Azure Machine Learning Model to Cluster Text Features - A True Smart App</title>
  <meta name="description" content="A tech piece on using one of my favorite web microframeworks to serve up some ML">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Creating a Python Flask Web App that Uses an Azure Machine Learning Model to Cluster Text Features - A True Smart App">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://localhost:4000/posts/a-python-flask-webapp-gets-smart">
  <meta property="og:description" content="A tech piece on using one of my favorite web microframeworks to serve up some ML">
  <meta property="og:site_name" content="Waterfalls of data">
  <meta property="og:image" content="http://localhost:4000/assets/og-image.jpg">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://localhost:4000/posts/a-python-flask-webapp-gets-smart">
  <meta name="twitter:title" content="Creating a Python Flask Web App that Uses an Azure Machine Learning Model to Cluster Text Features - A True Smart App">
  <meta name="twitter:description" content="A tech piece on using one of my favorite web microframeworks to serve up some ML">
  <meta name="twitter:image" content="http://localhost:4000/assets/og-image.jpg">

  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="http://localhost:4000/feed.xml" type="application/rss+xml" rel="alternate" title="Waterfalls of data Last 10 blog posts" />

  
    <link type="text/css" rel="stylesheet" href="/assets/light.css">
  
</head>

<body>
  <main role="main">
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav reveal">
  <a href="/" class="header-logo" title="Waterfalls of data">Waterfalls of data</a>
  <ul class="header-links">
    
    
      <li>
        <a href="https://twitter.com/analyze_more" target="_blank" title="Twitter">
          <span class="icon icon-social-twitter"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="https://github.com/michhar" target="_blank" title="GitHub">
          <span class="icon icon-social-github"></span>
        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://www.linkedin.com/in/micheleenharris" target="_blank" title="LinkedIn">
          <span class="icon icon-social-linkedin"></span>
        </a>
      </li>
    
    
    
    
      <li>
        <a href="/feed.xml" target="_blank" title="RSS">
          <span class="icon icon-social-rss"></span>
        </a>
      </li>
    
  </ul>
</nav>

        <article class="article reveal">
          <header class="article-header">
            <h1>Creating a Python Flask Web App that Uses an Azure Machine Learning Model to Cluster Text Features - A True Smart App</h1>
            <p>A tech piece on using one of my favorite web microframeworks to serve up some ML</p>
            <div class="article-list-footer">
              <span class="article-list-date">
                February 3, 2017
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  19 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
                  <a href="/tag/python">python</a>
                
                  <a href="/tag/dev">dev</a>
                
                  <a href="/tag/visual-studio">visual-studio</a>
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <p><img src="/resources/images/flask-post-diagram.png" alt="input for webapp" /></p>

<p><a href="https://en.wikipedia.org/wiki/TL;DR"><strong>tl;dr</strong></a>:  Azure Machine Learning + Visual Studio + Python Flask + GitHub + Azure = A Live Custom ML Model for You!</p>

<p>Ok, so I have an interesting REST endpoint (in my case, a machine learning model for using a company’s Wikipedia article to find similar companies), what can I do next?  Why not serve it up in a simple web app to impress friends and wow colleagues?  (Really, you can use this intel to create a web app around any REST endpoint, as half of my purpose in writing this is to show how fast and easy Python Flask is).</p>

<p>Essentially, we are making a web app wrapper around a data submission and retrieval REST endpoint that is created through Azure Machine Learning (AML) Studio (<a href="https://studio.azureml.net">https://studio.azureml.net</a>), a friendly and powerful machine learning tool with a handy browser UI.  In this post, the endpoint is a service that clusters companies based on descriptive text (our input data).  The clustering model, a k-means algorithm, has been trained on close to 500 wikipedia entries, a cool example of <a href="https://docs.microsoft.com/en-us/azure/machine-learning/machine-learning-algorithm-choice#unsupervised">unsupervised learning</a>.  If you don’t know much yet about AML Studio and would like to know more <a href="https://docs.microsoft.com/en-us/azure/machine-learning/machine-learning-what-is-ml-studio">this</a> is a good place to start or dive in and learn by doing with a quick getting-started tutorial <a href="https://docs.microsoft.com/en-us/azure/machine-learning/machine-learning-create-experiment">here</a>.  You’ll need to know, at least, how to publish an experiment from Studio to get your Flask web app going.</p>

<p>The ML web service is based around an AML scoring experiment, built from a training experiment in which <code class="highlighter-rouge">K-Means Clustering</code> module is used to assign companies to groups based on features in their processed Wikipedia text.   The <code class="highlighter-rouge">Extract N-Gram Features from Text</code> module (more info <a href="https://msdn.microsoft.com/library/azure/a8a662d0-89bb-48c9-8562-9b9589124c4a">here</a>) is used after some initial cleansing of the text data (remove stop words, numbers, special characters, detect sentences, etc. - see the <code class="highlighter-rouge">Preprocess Text</code> AML module <a href="https://msdn.microsoft.com/en-us/library/mt762915.aspx">here</a>) to extract features upon which to train the k-means clustering model and reduce the dimensionality to the most important chunks of information.  The scoring experiment uses a stored vocabulary from the training data n-gram feature extraction process.</p>

<p>Our web app is going to utilize a microframework for building web apps purely in the Python programming language.  A big reason to begin in this framework is that Python, a popular Data Science language, is easy to read and learn and Visual Studio has a Flask web app template as part of the Python Tools for Visual Studio extension, making life much easier for us.  Python, as a language, is also known for being a popular web app development language and has other projects like <a href="https://www.djangoproject.com/">Django</a> and <a href="https://bottlepy.org/docs/dev/">Bottle</a> for these ends (also with templates in VS).</p>

<p>That all being said, most of this post is about creating the Flask web app.  I’ll leave it to other guides and articles to discuss working with AML in detail.</p>

<p><img src="/resources/images/webapp-input.PNG" alt="input for webapp" />
<strong>Above:  The deployed web app site</strong></p>

<h3 id="before-you-begin-a-few-things-to-do">Before you Begin, a Few Things to Do…</h3>

<h4 id="tools">Tools</h4>
<ul>
  <li>[recommended]<strong>Visual Studio</strong> installed (using 2017 release candidate) (<a href="https://www.visualstudio.com/vs/visual-studio-2017-rc/">https://www.visualstudio.com/vs/visual-studio-2017-rc/</a>) with Python Tools for Visual Studio installed (to get the Flask Web App template)</li>
  <li><strong>Git Bash</strong> or <strong>git</strong> installed - included in git download
    <ul>
      <li><a href="https://git-scm.com/downloads">https://git-scm.com/downloads</a></li>
    </ul>
  </li>
</ul>

<h4 id="accounts">Accounts</h4>
<ul>
  <li><strong>Azure Machine Learning Studio account</strong> from <a href="https://studio.azureml.net">https://studio.azureml.net</a> (free)</li>
  <li><strong>GitHub Account</strong> - a code repository and collaboration tool we’ll use (free)
    <ul>
      <li><a href="https://github.com/join">https://github.com/join</a></li>
    </ul>
  </li>
  <li><strong>Azure account</strong> - use the one you have, sign up for a free trial at <a href="https://azure.microsoft.com/en-us/free/">https://azure.microsoft.com/en-us/free/</a>, or, if you have an MSDN account and Azure as a benefit, link your Microsoft Account or Work/School Account to MSDN and activate the Azure benefit by following <a href="https://www.visualstudio.com/en-us/docs/setup-admin/team-services/link-msdn-subscription-to-organizational-account-vs">this</a> guide</li>
</ul>

<h4 id="prerequisites">Prerequisites</h4>
<ul>
  <li>The deployed Azure Machine Learning <em>scoring</em> experiment
    <ul>
      <li>Note:  We won’t cover this experiment and model here as it’s not the focus of this particular post, but a link to instructions is just below.</li>
      <li>Aside:  These experiments are often called “predictive”, but in a clustering model we really just look for scores and cluster assignments, not predictions so let’s call it <em>scoring</em> experiment</li>
    </ul>
  </li>
</ul>

<p>The scoring experiment which utilizes the k-means model and n-gram featurizer vocabulary created in the training experiment has the following layout in AML Studio:</p>

<p><img src="/resources/images/aml-studio-scoring.png" alt="kmeans/ngram scoring experiment" /></p>

<p>The scoring experiment you will need can be found <a href="https://gallery.cortanaintelligence.com/Experiment/N-Grams-and-Clustering-Find-similar-companies-Scoring-Exp-2">here</a> (this will allow you to launch it in AML Studio).  Essentially, we are using AML Studio as a clever way to deploy a web service and not much more, but it’s capabilities as a canvas for creating a data science workflow are worth checking out if you like a visual workflow-type setup.</p>

<p>Start at this spot in the Azure Docs to get this experiment deployed as a web service to use later in this guide post:  <a href="https://docs.microsoft.com/en-us/azure/machine-learning/machine-learning-walkthrough-5-publish-web-service#deploy-the-web-service">https://docs.microsoft.com/en-us/azure/machine-learning/machine-learning-walkthrough-5-publish-web-service#deploy-the-web-service</a>.</p>

<p>A similar guide with good diagrams on deploying the experiment as a web service can be picked up at section “4.2.2. Publishing a trained model as Web Service” in this tutorial: <a href="https://github.com/Azure-Readiness/hol-azure-machine-learning/blob/master/004-lab-azureml-experiment.md#422-publishing-a-trained-model-as-web-service">https://github.com/Azure-Readiness/hol-azure-machine-learning/blob/master/004-lab-azureml-experiment.md#422-publishing-a-trained-model-as-web-service</a>.</p>

<h3 id="the-web-app-development">The Web App Development</h3>

<p><strong>Note:  Under REQUEST/RESPONSE for the AML Studio experiment (found after deploying as web service from Studio), one will find all of the specs needed to work with this endpoint.</strong></p>

<p>Let’s write a web app!  We’re going to begin in Visual Studio (I’m checking out the new VS 2017 release candidate, by the way).  Did you know VS 2017 is available for Mac as well?!  What’s especially cool is that developers can share projects across Mac and Windows.  The Python Tools for Visual Studio extension isn’t available, however, on VS 2017 RC for Mac so I’m eagerly awaiting this capability.  Will report back later.  Since it is available for us on Windows we will be using the awesome Flask Web Project template that comes with it to kick start our web app dev.</p>

<ul>
  <li>
    <p>Open VS</p>
  </li>
  <li>
    <p>Create a new Python Flask web app project (this template should exist if one chooses Python - scroll down Templates -&gt; Python -&gt; Flask Web Project) with Python 3.5 (or whichever 3 you have will do) into a virtual environment.  At this point, you literally have a functioning web app.  Hit the Run (your default browser choice is next to the button) in VS and test out this template.</p>
  </li>
  <li>
    <p>Add a new file called <code class="highlighter-rouge">forms.py</code> to the main directory (alongside <code class="highlighter-rouge">views.py</code>).  This will contain the form-building code through which data will be sent to the REST endpoint for analysis.  There are three fields we need in our input form: title, category and text.  Title is the company title, category is an optional field for the category of company (e.g. information technology) and text is the Wikipedia article text about that company or some descriptive corpus.</p>
  </li>
</ul>

<h4 id="the-input-form--define-in-forms">The input form:  define in “forms”</h4>

<p>Place the following text in the <code class="highlighter-rouge">forms.py</code> file:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">TextAreaField</span><span class="p">,</span> <span class="n">validators</span>

<span class="c"># This class will be used in the webapp as the main input form</span>
<span class="k">class</span> <span class="nc">SubmissionForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">'Title'</span><span class="p">,</span> <span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">30</span><span class="p">)])</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s">'Category'</span><span class="p">,</span> <span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">30</span><span class="p">)])</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">TextAreaField</span><span class="p">(</span><span class="s">'Text'</span><span class="p">,</span> <span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">Length</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1000</span><span class="p">)])</span>
</code></pre>
</div>

<h4 id="the-routing-on-the-page--define-in-the-views">The routing on the page:  define in the “views”</h4>

<p>We will be modifying the existing template code as follows.</p>

<p>The imports should look like:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">FlaskAppAML</span> <span class="kn">import</span> <span class="n">app</span>

<span class="kn">from</span> <span class="nn">FlaskAppAML.forms</span> <span class="kn">import</span> <span class="n">SubmissionForm</span></code></pre></figure>

<p>Which added json handling, http request handling, os interaction and the way in which the forms class from above is available for use.</p>

<p>Add a way to grab the API_KEY and URL at the beginning of the <code class="highlighter-rouge">views.py</code> file:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Deployment environment variables defined on Azure (pull in with os.environ)</span>
<span class="n">API_KEY</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'API_KEY'</span><span class="p">,</span> <span class="s">"optionally place a default value for local dev here"</span><span class="p">)</span>
<span class="n">URL</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'URL'</span><span class="p">,</span> <span class="s">"optionally place a default value for local dev here"</span><span class="p">)</span></code></pre></figure>

<p>and HEADERS global variable:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Construct the HTTP request header</span>
<span class="n">HEADERS</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Content-Type'</span><span class="p">:</span><span class="s">'application/json'</span><span class="p">,</span> <span class="s">'Authorization'</span><span class="p">:(</span><span class="s">'Bearer '</span><span class="o">+</span> <span class="n">API_KEY</span><span class="p">)}</span></code></pre></figure>

<p>Change the “home route” (landing page functionality), <code class="highlighter-rouge">def home</code> method definition, to be:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c"># Our main app page/route</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/home'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="s">"""Renders the home page which is the CNS of the web app currently, nothing pretty."""</span>

    <span class="n">form</span> <span class="o">=</span> <span class="n">SubmissionForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>

    <span class="c"># Form has been submitted</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>

        <span class="c"># Plug in the data into a dictionary object </span>
        <span class="c">#  - data from the input form</span>
        <span class="c">#  - text data must be converted to lowercase</span>
        <span class="n">data</span> <span class="o">=</span>  <span class="p">{</span>
              <span class="s">"Inputs"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">"input1"</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s">"ColumnNames"</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s">"Title"</span><span class="p">,</span>
                    <span class="s">"Category"</span><span class="p">,</span>
                    <span class="s">"Text"</span>
                  <span class="p">],</span>
                  <span class="s">"Values"</span><span class="p">:</span> <span class="p">[</span> <span class="p">[</span>
                      <span class="n">form</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                      <span class="n">form</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                      <span class="n">form</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="p">]</span>
                  <span class="p">]</span>
                <span class="p">}</span>
              <span class="p">},</span>
              <span class="s">"GlobalParameters"</span><span class="p">:</span> <span class="p">{}</span>
            <span class="p">}</span>

        <span class="c"># Serialize the input data into json string</span>
        <span class="n">body</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>

        <span class="c"># Formulate the request</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">HEADERS</span><span class="p">)</span>

        <span class="c"># Send this request to the AML service and render the results on page</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># response = requests.post(URL, headers=HEADERS, data=body)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            <span class="n">respdata</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">respdata</span><span class="p">,</span> <span class="s">'utf-8'</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s">'result.html'</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s">"From your friendly AML experiment's Web Service:"</span><span class="p">,</span>
                <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

        <span class="c"># An HTTP error</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">code</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s">'result.html'</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s">'There was an error'</span><span class="p">,</span>
                <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

    <span class="c"># Just serve up the input form</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s">'form.html'</span><span class="p">,</span>
        <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s">'Run App'</span><span class="p">,</span>
        <span class="n">year</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
        <span class="n">message</span><span class="o">=</span><span class="s">'Input form to gain insights into a company using Azure Machine Learning'</span><span class="p">)</span></code></pre></figure>

<h4 id="the-html-templates--how-the-information-gets-served">The html templates:  how the information gets served</h4>

<ul>
  <li>We add two new templates:  form.html, result.html</li>
</ul>

<p>The <code class="highlighter-rouge">form.html</code> gives us a construct for the user to enter in input data and the <code class="highlighter-rouge">result.html</code>, a construct in which the results from the machine learning experiment can be displayed.</p>

<p>Grab the <code class="highlighter-rouge">form.html</code> code <a href="https://github.com/michhar/flask-webapp-aml/blob/master/FlaskAppAML/templates/form.html">here</a>.
Grab the <code class="highlighter-rouge">result.html</code> code <a href="https://github.com/michhar/flask-webapp-aml/blob/master/FlaskAppAML/templates/result.html">here</a>.  Note, this code may result in slightly different web app appearances to this article.</p>

<p>Now that we have some new code to handle calling the AML web service and html templates to handle input and output, let’s prepare to deploy by taking a look at some configuration.</p>

<h3 id="prepare-to-deploy-the-web-app-to-azure">Prepare to Deploy the Web App to Azure</h3>

<p>Before we publish, we must add two configuration-type files:</p>

<ol>
  <li>A web configuration file (web.config)
    <ul>
      <li>Virtual environment proxy (ptvs_virtualenv_proxy.py)</li>
    </ul>
  </li>
</ol>

<p>The <code class="highlighter-rouge">web.config</code> file may need some modifications, however the virtual environment proxy file should work as is from this folder.</p>

<h4 id="web-configuration-file">Web Configuration file</h4>
<ol>
  <li>Add web.config at project level (alongside requirements.txt file)</li>
</ol>

<p>It should look something like the following (you can actually add a template web.config similar to this one in VS by right-clicking on the FlaskAppAML folder -&gt; Add -&gt; New Item -&gt; Azure web.config for FastCGI, but it will need a few modifications).  Note that the Python version may change in the future and this script might need modification.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
  <span class="nt">&lt;appSettings&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"WSGI_ALT_VIRTUALENV_HANDLER"</span> <span class="na">value=</span><span class="s">"FlaskAppAML.app"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"WSGI_ALT_VIRTUALENV_ACTIVATE_THIS"</span>
         <span class="na">value=</span><span class="s">"D:\home\site\wwwroot\env\Scripts\python.exe"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"WSGI_HANDLER"</span>
         <span class="na">value=</span><span class="s">"ptvs_virtualenv_proxy.get_venv_handler()"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"PYTHONPATH"</span> <span class="na">value=</span><span class="s">"D:\home\site\wwwroot"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/appSettings&gt;</span>
  <span class="nt">&lt;system.web&gt;</span>
    <span class="nt">&lt;compilation</span> <span class="na">debug=</span><span class="s">"true"</span> <span class="na">targetFramework=</span><span class="s">"4.0"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/system.web&gt;</span>
  <span class="nt">&lt;system.webServer&gt;</span>
    <span class="nt">&lt;modules</span> <span class="na">runAllManagedModulesForAllRequests=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;handlers&gt;</span>
      <span class="nt">&lt;remove</span> <span class="na">name=</span><span class="s">"Python27_via_FastCGI"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;remove</span> <span class="na">name=</span><span class="s">"Python34_via_FastCGI"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"Python FastCGI"</span>
           <span class="na">path=</span><span class="s">"handler.fcgi"</span>
           <span class="na">verb=</span><span class="s">"*"</span>
           <span class="na">modules=</span><span class="s">"FastCgiModule"</span>
           <span class="na">scriptProcessor=</span><span class="s">"D:\Python34\python.exe|D:\Python34\Scripts\wfastcgi.py"</span>
           <span class="na">resourceType=</span><span class="s">"Unspecified"</span>
           <span class="na">requireAccess=</span><span class="s">"Script"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/handlers&gt;</span>
    <span class="nt">&lt;rewrite&gt;</span>
      <span class="nt">&lt;rules&gt;</span>
        <span class="nt">&lt;rule</span> <span class="na">name=</span><span class="s">"Static Files"</span> <span class="na">stopProcessing=</span><span class="s">"true"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;match</span> <span class="na">url=</span><span class="s">"^/static/.*"</span> <span class="na">ignoreCase=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;action</span> <span class="na">type=</span><span class="s">"Rewrite"</span> <span class="na">url=</span><span class="s">"^/FlaskAppAML/static/.*"</span> <span class="na">appendQueryString=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/rule&gt;</span>
        <span class="nt">&lt;rule</span> <span class="na">name=</span><span class="s">"Configure Python"</span> <span class="na">stopProcessing=</span><span class="s">"true"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;match</span> <span class="na">url=</span><span class="s">"(.*)"</span> <span class="na">ignoreCase=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;conditions&gt;</span>
          <span class="nt">&lt;/conditions&gt;</span>
          <span class="nt">&lt;action</span> <span class="na">type=</span><span class="s">"Rewrite"</span> <span class="na">url=</span><span class="s">"handler.fcgi/{R:1}"</span> <span class="na">appendQueryString=</span><span class="s">"true"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/rule&gt;</span>
      <span class="nt">&lt;/rules&gt;</span>
    <span class="nt">&lt;/rewrite&gt;</span>
  <span class="nt">&lt;/system.webServer&gt;</span>
<span class="nt">&lt;/configuration&gt;</span></code></pre></figure>

<p>Possible modifications or places of note in the web config:</p>

<ul>
  <li>
    <p>The <code class="highlighter-rouge">WSGI_ALT_VIRTUALENV_HANDLER</code> will very likely need to be modified.  Here it is <code class="highlighter-rouge">FlaskAppAML.app</code>, referring to my flask application itself.</p>
  </li>
  <li>
    <p>The line <code class="highlighter-rouge">&lt;action type="Rewrite" url="^/FlaskAppAML/static/.*" appendQueryString="true" /&gt;</code> under rules MUST have the correct project name (here mine was FlaskAppAML).  This section ensures the static files (important for the web service appearance) can be found.</p>
  </li>
  <li>
    <p>The <code class="highlighter-rouge">scriptProcessor</code>, under <code class="highlighter-rouge">handlers</code> in the web.config xml above, must correspond to the resources existing on the web server’s file system (e.g. <code class="highlighter-rouge">D:\Python34\python.exe</code>).</p>
  </li>
</ul>

<h4 id="virtual-environment-proxy">Virtual Environment Proxy</h4>

<p>The code for this set of helper functions can be found <a href="https://docs.microsoft.com/en-us/azure/app-service-web/web-sites-python-configure#virtual-environment-proxy">here</a> in the Azure documentation (that similar article talks about deploying continuously from a git repository - a good method to know as well).</p>

<p>Just include <code class="highlighter-rouge">ptvs_virtualenv_proxy</code> in the base of your project along with the <code class="highlighter-rouge">web.config</code> (and auto-created <code class="highlighter-rouge">requirements.txt</code> and <code class="highlighter-rouge">runserver.py</code>).</p>

<h3 id="deploy-the-flask-web-app">Deploy the Flask Web App</h3>

<h4 id="option-1-set-up-a-github-repository-as-the-deployment-option">Option 1: Set up a GitHub Repository as the Deployment Option</h4>

<p>This is the most customizable way, hence more complex, but also the most transparent and easy to troubleshoot.</p>

<ol>
  <li>Log in to GitHub and create a new repository, initializing with a README and a .gitignore for Visual Studio files.</li>
  <li>In Git bash on the Desktop, type into the terminal the command to clone the new repository, for example, my repository is called <code class="highlighter-rouge">flask-webapp-aml</code> so I clone with (I’m using SSH because it will allow me to push changes back up):
    <ul>
      <li><code class="highlighter-rouge">git clone git@github.com:michhar/flask-webapp-aml.git</code></li>
    </ul>
  </li>
  <li>Copy all of the project code to this new repository folder locally (I just <code class="highlighter-rouge">cp</code> on the command line in Git bash) to match this structure:</li>
</ol>

<div class="language-text highlighter-rouge"><pre class="highlight"><code>  FlaskAppAML/
  FlaskAppAML/__init__.py
  FlaskAppAML/forms.py
  FlaskAppAML/views.py
  FlaskAppAML/static -&gt; *our static files*
  FlaskAppAML/templates -&gt; *the html page templates*
  env/ -&gt; *the entire python environment*
  ptvs_virtualenv_proxy.py
  README.md
  requirements.txt
  runserver.py
  runtime.txt
  web.config
  .skipPythonDeployment
</code></pre>
</div>
<ol>
  <li>If the empty <code class="highlighter-rouge">.skipPythonDeployment</code> file is not in the base of your repository, add one now.  Also, make sure the <code class="highlighter-rouge">env</code> folder from the VS project is present.  This contains all of the python environment needed for running this web app (really anywhere).  We are skipping having the web service custom install all of the necessary modules by giving the service this <code class="highlighter-rouge">.skipPythonDeployment</code> file and the <code class="highlighter-rouge">env</code> folder.</li>
  <li>Add “__pycache__” on it’s own line to my “.gitignore” file and anything you don’t want uploaded to the GitHub when we “push” changes.</li>
  <li>Now it all seems pretty tidy, so it’s time to push the changes up to be hosted on GitHub.  I <em>add</em> (“stage”), <em>commit</em> (commit my code locally with a message) and <em>push</em> (push up to the web to be hosted on GitHub) all of my additions or any changes I’ve made.  I can do this <em>add/commit/push</em> again as many times as I want in the future.  I must, however, do all three consecutively and in that order otherwise it gets complicated.  So, my commands look like:
    <ul>
      <li><code class="highlighter-rouge">git add .</code> (from the base of the repository)</li>
      <li><code class="highlighter-rouge">git commit -m "initial commit message"</code> (the -m is our message so be brief, but descriptive - visible to the world)</li>
      <li><code class="highlighter-rouge">git push</code> (we could also have written <code class="highlighter-rouge">git push origin master</code>, but it’s not necessary to be so verbose right now)</li>
    </ul>
  </li>
  <li>Create an App Service Web App in the Azure Portal (https://portal.azure.com) by clicking “+” and search for “web app”, then go through the wizard to create one.</li>
  <li>Update the Deployment options in the Azure Portal for the web app.  For our Web App, under “APP DEPLOYMENT”, open the “Deployment options” blade.  For Choose Source, choose GitHub (you may have to log in to your GitHub here to link it).  Under Choose project, pick the GitHub repository to which you just pushed code and click OK.</li>
  <li>Now we add a couple of variables to the Azure Portal Web App for safe-keeping.  There are “environmental variables” in the code (they look like <code class="highlighter-rouge">os.environ.get('FOO')</code>):  one for the AML Web Service’s URL and one for the API_KEY - these are the necessary values we need to access our published AML scoring experiment.  To have these available for our web app we need to put them somewhere discoverable and that is as variables under “App settings” in the “Application settings” blade for our own Web App in the Azure Portal.
 <img src="/resources/images/flaskapp-adding-sys-vars.jpg" alt="image of entering in keys to Azure portal app service" /></li>
  <li>Ensure that, in the Portal, under Application Settings, Python is set to the appropriate version (default is that “Python” is Off in settings - so will need to manually switch to it’s version).</li>
  <li>If we go back to the “Deployment options” we can see how our build is going.  This process will automatically happen for us every time a new change is made to our GitHub repository.  Ensure that this build completes successfully.</li>
</ol>

<p>Congrats on completing this process!  You should now have a functioning barebones, machine learning web app.  Go ahead and try it out. :)</p>

<p><img src="/resources/images/webapp-output.PNG" alt="input for webapp" /></p>

<p>If you encounter any problems, check the Troubleshooting section below, Azure docs, or StackOverflow.  Also, leave a comment if it’s a bug in the code or process.</p>

<h4 id="option-2-publish-and-deploy-from-vs-as-an-azure-app-service-web-app">Option 2: Publish and Deploy from VS as an Azure App Service Web App</h4>

<p>To deploy we must also publish this project to Azure (it’s done together with VS).  Fortunately, from within VS (note, I’m in VS 2017, but it’s available in previous releases) there’s a <strong>“Publish…“</strong> option.  Right-click on the project name and in the pop-up <strong>“Publish…“</strong> should be available.  Click this and simply go through the wizard to set up an Azure App Service Web App.  It should be very straightforward and easy to do.</p>

<p>As an alternative to publishing/deploying directly from VS, one can leverage a git repository or use code on GitHub as a deployment option.  Similar instructions can be found in <a href="https://docs.microsoft.com/en-us/azure/app-service-web/web-sites-python-configure">this</a> Azure article.</p>

<h3 id="make-it-your-own">Make it Your Own</h3>

<p>Modify the <code class="highlighter-rouge">layout.html</code> file with app name and navi layout changes.  Or change your custom stylesheet under static -&gt; content -&gt; site.css.</p>

<p>Go grab all of the code at https://github.com/michhar/flask-webapp-aml and add it to a project, test, develop and deploy.  You could even if you wish just fork this repository and deploy directly from that in the Azure Portal, but then that would have been too easy. ;)</p>

<h3 id="troubleshooting">Troubleshooting</h3>

<ul>
  <li>All sample code can be found at https://github.com/michhar/flask-webapp-aml - it may, over time, have more complex samples, so check it out.</li>
  <li>Go to Application Settings and ensure Python is enabled along with other key settings in the Azure Portal</li>
  <li>Go to Console (under Development Tools) and make sure all files and programs specified in the <code class="highlighter-rouge">web.config</code> exists.</li>
  <li>Ensure in <code class="highlighter-rouge">web.config</code>, that the “scriptProcessor” key/value in handlers is correct (that these paths exist on the server file system).</li>
  <li>Check FREB Logs in the Portal for more information around warnings and errors (make sure you are logging for those during this phase).</li>
  <li>Post comments here or if around the code, under issues here:  https://github.com/michhar/flask-webapp-aml/issues - many thanks!</li>
</ul>

          </div>

          <div class="article-share">
            
            <a href="" title="Share on Twitter" onclick="window.open('https://twitter.com/home?status=Creating a Python Flask Web App that Uses an Az... - http://localhost:4000/posts/a-python-flask-webapp-gets-smart by @analyze_more', 'newwindow', 'width=500, height=225'); return false;">
              <span class="icon icon-social-twitter"></span>
            </a>
            <a href="" title="Share on Facebook" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/posts/a-python-flask-webapp-gets-smart', 'newwindow', 'width=500, height=500'); return false;">
              <span class="icon icon-social-facebook"></span>
            </a>
            <a href="" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=http://localhost:4000/posts/a-python-flask-webapp-gets-smart', 'newwindow', 'width=550, height=400'); return false;">
              <span class="icon icon-social-googleplus"></span>
            </a>
          </div>

          
            <div id="disqus_thread" class="article-comments"></div>
            <script>
              (function() {
                  var d = document, s = d.createElement('script');
                  s.src = '//blog-vf2v0kav1a.disqus.com/embed.js';
                  s.setAttribute('data-timestamp', +new Date());
                  (d.head || d.body).appendChild(s);
              })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          
        </article>
        <footer class="footer reveal">
  <p>
    Thanks for visiting.  Come back soon.<br>
    <a href="/about" title="About me">~ Micheleen Harris ~</a>.
  </p>
</footer>

      </div>
    </div>
  </main>
  <script type="text/javascript" src="/assets/vendor.js"></script>
<script type="text/javascript" src="/assets/application.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Cormorant Garamond:700', 'Lato:300,400,700']
    }
  });
</script>


  <script>
    window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
    ga('create','UA-86308542-1','auto');ga('send','pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>


</body>
</html>
